name: Security Scanning

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # .NET/C# Security Scanning
  dotnet-security:
    name: .NET Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0'

      - name: Restore dependencies
        run: dotnet restore

      - name: Install Security Code Scan
        run: dotnet tool install --global security-scan

      - name: Run Security Code Scan
        run: |
          dotnet security-scan --project . --export security-scan-results.sarif --sarif
        continue-on-error: true

      - name: Upload Security Code Scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: security-scan-results.sarif
          category: dotnet-security

  # Ruby on Rails Security Scanning
  brakeman:
    name: Brakeman Rails Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Brakeman
        run: gem install brakeman

      - name: Run Brakeman
        run: |
          brakeman -f json -o brakeman-results.json --no-pager
        continue-on-error: true

      - name: Upload Brakeman results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: brakeman-results
          path: brakeman-results.json

  # Python Security Scanning
  bandit:
    name: Bandit Python Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit
        run: |
          bandit -r . -f json -o bandit-results.json
        continue-on-error: true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-results
          path: bandit-results.json

  # Bash Script Security
  shellcheck:
    name: ShellCheck Bash Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: warning
          format: gcc
        continue-on-error: true

  # PowerShell Security
  psscriptanalyzer:
    name: PSScriptAnalyzer PowerShell
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings PSGallery
          $results | ConvertTo-Json -Depth 10 | Out-File -FilePath psscriptanalyzer-results.json
        continue-on-error: true

      - name: Upload PSScriptAnalyzer results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: psscriptanalyzer-results
          path: psscriptanalyzer-results.json

  # SQL Linting
  sqlfluff:
    name: SQLFluff SQL Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install SQLFluff
        run: pip install sqlfluff

      - name: Run SQLFluff
        run: |
          sqlfluff lint --format json --dialect ansi . > sqlfluff-results.json || true
        continue-on-error: true

      - name: Upload SQLFluff results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sqlfluff-results
          path: sqlfluff-results.json

  # T-SQL Linting
  tsqllint:
    name: TSQLLint T-SQL Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0'

      - name: Install TSQLLint
        run: dotnet tool install --global TSQLLint

      - name: Run TSQLLint
        run: |
          find . -name "*.sql" -type f | xargs -I {} tsqllint {} || true
        continue-on-error: true

  # Terraform Security
  terraform-security:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy for IaC
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-iac-results.sarif'
        continue-on-error: true

      - name: Upload Trivy IaC results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-iac-results.sarif
          category: terraform-security

  # Docker Container Scanning
  trivy-containers:
    name: Trivy Container CVE Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find Dockerfiles
        id: dockerfiles
        run: |
          DOCKERFILES=$(find . -name "Dockerfile*" -type f)
          echo "dockerfiles<<EOF" >> $GITHUB_OUTPUT
          echo "$DOCKERFILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-container-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy container results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-container-results.sarif
          category: container-security

  # Dockerfile Linting
  hadolint:
    name: Hadolint Dockerfile Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          recursive: true
          format: sarif
          output-file: hadolint-results.sarif
        continue-on-error: true

      - name: Upload Hadolint results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint-results.sarif
          category: dockerfile-linting

  # Secrets Scanning
  trufflehog:
    name: TruffleHog Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --only-verified
        continue-on-error: true

  # Semgrep Multi-language Security
  semgrep:
    name: Semgrep Security Analysis
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan --config=p/security-audit \
                       --config=p/owasp-top-ten \
                       --config=p/cwe-top-25 \
                       --config=p/sql-injection \
                       --config=p/secrets \
                       --config=p/csharp \
                       --sarif --output=semgrep-results.sarif \
                       --severity=ERROR --severity=WARNING
        continue-on-error: true

      - name: Upload Semgrep results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep-security

  # Results Aggregation
  aggregate-results:
    name: Aggregate Security Results
    runs-on: ubuntu-latest
    needs: [
      dotnet-security,
      brakeman,
      bandit,
      shellcheck,
      psscriptanalyzer,
      sqlfluff,
      tsqllint,
      terraform-security,
      trivy-containers,
      hadolint,
      trufflehog,
      semgrep
    ]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-results

      - name: Create summary
        run: |
          echo "# Security Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Status" >> $GITHUB_STEP_SUMMARY
          echo "- .NET Security: ${{ needs.dotnet-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Brakeman (Rails): ${{ needs.brakeman.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bandit (Python): ${{ needs.bandit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ShellCheck (Bash): ${{ needs.shellcheck.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- PSScriptAnalyzer (PowerShell): ${{ needs.psscriptanalyzer.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SQLFluff: ${{ needs.sqlfluff.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- TSQLLint: ${{ needs.tsqllint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform Security: ${{ needs.terraform-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Containers: ${{ needs.trivy-containers.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Hadolint: ${{ needs.hadolint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- TruffleHog: ${{ needs.trufflehog.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Semgrep: ${{ needs.semgrep.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more security scans failed"
            exit 1
          fi
