name: Security Scanning
on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write

jobs:
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config=p/golang \
            --config=p/csharp \
            --config=p/python \
            --config=p/java \
            --config=p/javascript \
            --config=p/typescript \
            --config=p/php \
            --config=p/ruby \
            --config=p/security-audit \
            --sarif -o semgrep.sarif \
            --json -o semgrep.json
        continue-on-error: true

      - name: Check for ERROR-level findings
        run: |
          ERRORS=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep.json)
          echo "ERROR-level findings: $ERRORS"
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found $ERRORS ERROR-level findings"
            exit 1
          fi

      - name: Post PR Comments
        uses: reviewdog/action-sarif@v1
        if: github.event_name == 'pull_request'
        with:
          name: Semgrep
          sarif_file: semgrep.sarif
          reporter: github-pr-review
          level: info
          fail_on_error: false
          filter_mode: added

      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: semgrep.sarif
          retention-days: 1

  sqlfluff:
    name: SQLFluff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for SQL files
        id: check_sql
        run: |
          if find . -type f -name "*.sql" | grep -q .; then
            echo "has_sql=true" >> $GITHUB_OUTPUT
          else
            echo "has_sql=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check_sql.outputs.has_sql == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install SQLFluff
        if: steps.check_sql.outputs.has_sql == 'true'
        run: pip install sqlfluff sqlfluff-templater-dbt

      - name: Run SQLFluff
        if: steps.check_sql.outputs.has_sql == 'true'
        run: sqlfluff lint . --format json --dialect tsql > sqlfluff.json || true
        continue-on-error: true

      - name: Convert to SARIF
        if: steps.check_sql.outputs.has_sql == 'true'
        run: |
          python3 << 'EOF'
          import json
          
          sarif = {
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "SQLFluff",
                          "version": "1.0.0",
                          "informationUri": "https://www.sqlfluff.com/"
                      }
                  },
                  "results": []
              }]
          }
          
          try:
              with open('sqlfluff.json', 'r') as f:
                  data = json.load(f)
              
              for violation in data:
                  rule_code = violation.get('code', 'unknown')
                  description = violation.get('description', 'No description')
                  filepath = violation.get('filepath', 'unknown')
                  line = violation.get('line_no', 1)
                  col = violation.get('line_pos', 1)
                  
                  # Map to SARIF levels
                  if rule_code.startswith('L0'):
                      level = 'note'
                  elif rule_code.startswith('L'):
                      level = 'warning'
                  else:
                      level = 'warning'
                  
                  result = {
                      "ruleId": rule_code,
                      "level": level,
                      "message": {"text": description},
                      "locations": [{
                          "physicalLocation": {
                              "artifactLocation": {"uri": filepath},
                              "region": {"startLine": line, "startColumn": col}
                          }
                      }]
                  }
                  sarif["runs"][0]["results"].append(result)
          except:
              pass
          
          with open('sqlfluff.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)
          EOF

      - name: Create empty SARIF if no SQL
        if: steps.check_sql.outputs.has_sql == 'false'
        run: |
          cat > sqlfluff.sarif << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{"tool": {"driver": {"name": "SQLFluff"}}, "results": []}]
          }
          EOF

      - name: Post PR Comments
        uses: reviewdog/action-sarif@v1
        if: github.event_name == 'pull_request' && steps.check_sql.outputs.has_sql == 'true'
        with:
          name: SQLFluff
          sarif_file: sqlfluff.sarif
          reporter: github-pr-review
          level: info
          fail_on_error: false
          filter_mode: added

      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: sqlfluff-sarif
          path: sqlfluff.sarif
          retention-days: 1

  tsqllint:
    name: TSQLLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for SQL files
        id: check_sql
        run: |
          if find . -type f -name "*.sql" | grep -q .; then
            echo "has_sql=true" >> $GITHUB_OUTPUT
          else
            echo "has_sql=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup .NET
        if: steps.check_sql.outputs.has_sql == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install TSQLLint
        if: steps.check_sql.outputs.has_sql == 'true'
        run: dotnet tool install --global TSQLLint

      - name: Run TSQLLint
        if: steps.check_sql.outputs.has_sql == 'true'
        run: ~/.dotnet/tools/tsqllint . > tsqllint.txt || true
        continue-on-error: true

      - name: Convert to SARIF
        if: steps.check_sql.outputs.has_sql == 'true'
        run: |
          python3 << 'EOF'
          import json
          import re
          
          sarif = {
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "TSQLLint",
                          "version": "1.0.0"
                      }
                  },
                  "results": []
              }]
          }
          
          try:
              with open('tsqllint.txt', 'r') as f:
                  lines = f.readlines()
              
              pattern = r'(.+?)\((\d+),(\d+)\)\s*:\s*(error|warning|information)\s+(\S+)\s*:\s*(.+)'
              
              for line in lines:
                  match = re.match(pattern, line, re.IGNORECASE)
                  if match:
                      filepath, line_num, col_num, level, code, message = match.groups()
                      
                      level_map = {'error': 'error', 'warning': 'warning', 'information': 'note'}
                      sarif_level = level_map.get(level.lower(), 'warning')
                      
                      result = {
                          "ruleId": code,
                          "level": sarif_level,
                          "message": {"text": message.strip()},
                          "locations": [{
                              "physicalLocation": {
                                  "artifactLocation": {"uri": filepath},
                                  "region": {"startLine": int(line_num), "startColumn": int(col_num)}
                              }
                          }]
                      }
                      sarif["runs"][0]["results"].append(result)
          except:
              pass
          
          with open('tsqllint.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)
          EOF

      - name: Create empty SARIF if no SQL
        if: steps.check_sql.outputs.has_sql == 'false'
        run: |
          cat > tsqllint.sarif << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{"tool": {"driver": {"name": "TSQLLint"}}, "results": []}]
          }
          EOF

      - name: Post PR Comments
        uses: reviewdog/action-sarif@v1
        if: github.event_name == 'pull_request' && steps.check_sql.outputs.has_sql == 'true'
        with:
          name: TSQLLint
          sarif_file: tsqllint.sarif
          reporter: github-pr-review
          level: info
          fail_on_error: false
          filter_mode: added

      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: tsqllint-sarif
          path: tsqllint.sarif
          retention-days: 1

  powershell:
    name: PowerShell Analysis
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for PowerShell files
        id: check_ps
        shell: pwsh
        run: |
          $psFiles = Get-ChildItem -Path . -Recurse -Include *.ps1,*.psm1,*.psd1 -ErrorAction SilentlyContinue
          if ($psFiles) {
            echo "has_ps=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "has_ps=false" >> $env:GITHUB_OUTPUT
          }

      - name: Run PSScriptAnalyzer
        if: steps.check_ps.outputs.has_ps == 'true'
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Severity Error,Warning,Information
          
          # Build SARIF
          $sarif = @{
            '$schema' = 'https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json'
            version = '2.1.0'
            runs = @(@{
              tool = @{
                driver = @{
                  name = 'PSScriptAnalyzer'
                  version = '1.0.0'
                }
              }
              results = @()
            })
          }
          
          foreach ($result in $results) {
            $level = switch ($result.Severity) {
              'Error' { 'error' }
              'Warning' { 'warning' }
              'Information' { 'note' }
              default { 'note' }
            }
            
            $sarif.runs[0].results += @{
              ruleId = $result.RuleName
              level = $level
              message = @{ text = $result.Message }
              locations = @(@{
                physicalLocation = @{
                  artifactLocation = @{ uri = $result.ScriptPath }
                  region = @{ startLine = $result.Line }
                }
              })
            }
          }
          
          $sarif | ConvertTo-Json -Depth 10 | Out-File -FilePath powershell.sarif

      - name: Create empty SARIF if no PS files
        if: steps.check_ps.outputs.has_ps == 'false'
        shell: pwsh
        run: |
          @{
            '$schema' = 'https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json'
            version = '2.1.0'
            runs = @(@{
              tool = @{ driver = @{ name = 'PSScriptAnalyzer' } }
              results = @()
            })
          } | ConvertTo-Json -Depth 5 | Out-File -FilePath powershell.sarif

      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: powershell-sarif
          path: powershell.sarif
          retention-days: 1

  checkov:
    name: Checkov IaC
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: all
          output_format: sarif
          output_file_path: ./
          soft_fail: true

      - name: Post PR Comments
        uses: reviewdog/action-sarif@v1
        if: github.event_name == 'pull_request'
        with:
          name: Checkov
          sarif_file: results.sarif
          reporter: github-pr-review
          level: info
          fail_on_error: false
          filter_mode: added

      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: checkov-sarif
          path: results.sarif
          retention-days: 1

  trivy:
    name: Trivy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret,config'
          format: 'sarif'
          output: 'trivy.sarif'
        continue-on-error: true

      - name: Post PR Comments
        uses: reviewdog/action-sarif@v1
        if: github.event_name == 'pull_request'
        with:
          name: Trivy
          sarif_file: trivy.sarif
          reporter: github-pr-review
          level: info
          fail_on_error: false
          filter_mode: added

      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sarif
          path: trivy.sarif
          retention-days: 1

  trufflehog:
    name: TruffleHog
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        run: |
          docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest \
            filesystem /pwd \
            --json \
            --only-verified > trufflehog.json || true
        continue-on-error: true

      - name: Convert to SARIF
        run: |
          python3 << 'EOF'
          import json
          
          sarif = {
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "TruffleHog",
                          "version": "3.0.0"
                      }
                  },
                  "results": []
              }]
          }
          
          try:
              with open('trufflehog.json', 'r') as f:
                  for line in f:
                      try:
                          finding = json.loads(line.strip())
                          
                          result = {
                              "ruleId": finding.get('DetectorName', 'secret-detected'),
                              "level": "error",
                              "message": {"text": f"Secret detected: {finding.get('DetectorName', 'unknown')}"},
                              "locations": [{
                                  "physicalLocation": {
                                      "artifactLocation": {"uri": finding.get('SourceMetadata', {}).get('Data', {}).get('Filesystem', {}).get('file', 'unknown')},
                                      "region": {"startLine": 1}
                                  }
                              }]
                          }
                          sarif["runs"][0]["results"].append(result)
                      except:
                          continue
          except:
              pass
          
          with open('trufflehog.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)
          EOF

      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-sarif
          path: trufflehog.sarif
          retention-days: 1

  report:
    name: Aggregate Report
    runs-on: ubuntu-latest
    needs: [semgrep, sqlfluff, tsqllint, powershell, checkov, trivy, trufflehog]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Download all SARIF files
        uses: actions/download-artifact@v4
        with:
          pattern: '*-sarif'

      - name: Generate Summary
        run: |
          python3 << 'EOF'
          import json
          import glob
          import os
          
          def parse_sarif(filepath):
              try:
                  with open(filepath, 'r') as f:
                      sarif = json.load(f)
              except:
                  return None, {'error': 0, 'warning': 0, 'note': 0}
              
              counts = {'error': 0, 'warning': 0, 'note': 0}
              tool_name = 'Unknown'
              
              for run in sarif.get('runs', []):
                  tool_name = run.get('tool', {}).get('driver', {}).get('name', 'Unknown')
                  
                  for result in run.get('results', []):
                      level = result.get('level', 'warning')
                      if level in counts:
                          counts[level] += 1
              
              return tool_name, counts
          
          # Find all SARIF files
          sarif_files = []
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.sarif'):
                      sarif_files.append(os.path.join(root, file))
          
          results = {}
          for filepath in sarif_files:
              tool_name, counts = parse_sarif(filepath)
              if tool_name and tool_name != 'Unknown':
                  results[tool_name] = counts
          
          # Generate markdown table
          summary = "## ðŸ”’ Security Scan Summary\n\n"
          
          if results:
              summary += "| Tool | ðŸ”´ High | ðŸŸ  Medium | ðŸ”µ Low | Total |\n"
              summary += "|------|---------|-----------|--------|-------|\n"
              
              grand_total = {'error': 0, 'warning': 0, 'note': 0}
              
              for tool in sorted(results.keys()):
                  counts = results[tool]
                  total = sum(counts.values())
                  summary += f"| {tool} | {counts['error']} | {counts['warning']} | {counts['note']} | **{total}** |\n"
                  
                  for level in grand_total:
                      grand_total[level] += counts[level]
              
              total_findings = sum(grand_total.values())
              summary += f"| **Total** | **{grand_total['error']}** | **{grand_total['warning']}** | **{grand_total['note']}** | **{total_findings}** |\n\n"
              
              if grand_total['error'] > 0:
                  summary += "ðŸ”´ **Action Required**: High severity findings detected\n"
              elif grand_total['warning'] > 0:
                  summary += "ðŸŸ  **Review Recommended**: Medium severity findings detected\n"
              else:
                  summary += "âœ… **No critical issues found**\n"
          else:
              summary += "No security findings detected.\n"
          
          with open('security-summary.md', 'w') as f:
              f.write(summary)
          
          # Also write to GitHub Step Summary
          with open(os.environ.get('GITHUB_STEP_SUMMARY', '/dev/null'), 'a') as f:
              f.write(summary)
          
          print(summary)
          EOF

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Security Scan Summary')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }
